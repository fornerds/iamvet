# κ·Όλ³Έ μ›μΈ λ¶„μ„ λ° ν•΄κ²° λ°©μ•

## μ§„λ‹¨ κ²°κ³Ό μ”μ•½

### λ°κ²¬λ λ¬Έμ 

1. **λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° ν’€ λ―Έμ„¤μ • (μ£Όμ” μ›μΈ)**
   - Prisma: μ—°κ²° ν’€ νλΌλ―Έν„° μ—†μ β οΈ
   - `pg` Pool: `max: 20` β… μ„¤μ •λ¨
   - **DATABASE_URLμ— μ—°κ²° ν’€ νλΌλ―Έν„° μ—†μ** β οΈ

2. **λ©”λ¨λ¦¬ μ‚¬μ©λ¥  λ†’μ (82%)**
   - μ „μ²΄ λ©”λ¨λ¦¬: 3.7GB
   - μ‚¬μ© μ¤‘: 2.8GB (82%)
   - Next.js: 279MB (7.1%) - **μ •μƒ λ²”μ„**
   - μμ‹¬ ν”„λ΅μ„Έμ¤: `/tmp/runnv/runnv` - 2.4GB (61%) - **Next.jsμ™€ λ¬΄κ΄€**

3. **μ—λ¬ λ΅κ·Έ**
   - `Invalid character in header content ["x-action-redirect"]` - ν—¤λ” λ¬Έμ 
   - `Connection closed` - λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° λκΉ€

4. **μ„λ²„ μ‚¬μ–‘**
   - CPU: 2μ½”μ–΄ (Intel Xeon Platinum)
   - λ©”λ¨λ¦¬: 3.7GB
   - **Next.js λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ€ μ •μƒ** (279MB)

## κ·Όλ³Έ μ›μΈ λ¶„μ„

### β… κ²°λ΅ : Next.js μ„λ²„ μμ²΄λ” λ¬Έμ  μ—†μ

**μ¦κ±°**:
1. Next.js λ©”λ¨λ¦¬ μ‚¬μ©λ‰: 279MB (μ •μƒ)
2. μ‘λ‹µ μ‹κ°„: 0.014-0.019μ΄ (μ •μƒ)
3. PM2 μ¬μ‹μ‘ νμ: 3ν (μ •μƒ λ²”μ„)

### β οΈ μ‹¤μ  λ¬Έμ : λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° λ„μ κ°€λ¥μ„±

**λ°κ²¬ μ‚¬ν•­**:
1. **Prisma μ—°κ²° ν’€ λ―Έμ„¤μ •**
   - `DATABASE_URL`μ— `connection_limit` νλΌλ―Έν„° μ—†μ
   - Prismaλ” κΈ°λ³Έμ μΌλ΅ λ¬΄μ ν• μ—°κ²° κ°€λ¥
   - μ—°κ²°μ΄ μ λ€λ΅ λ‹«νμ§€ μ•μΌλ©΄ μ—°κ²° λ„μ λ°μƒ

2. **μ¤‘λ³µ Pool μƒμ„±**
   - `src/lib/database.ts`: Pool μƒμ„± (max: 20)
   - `src/lib/db.ts`: Pool μƒμ„± (max: 20)
   - λ‘ κ°μ λ…λ¦½μ μΈ μ—°κ²° ν’€ μ΅΄μ¬

3. **μ—°κ²° λ¨λ‹ν„°λ§ λ¶€μ¬**
   - ν„μ¬ ν™μ„± μ—°κ²° μλ¥Ό ν™•μΈν•  λ°©λ²•μ΄ μ—†μ
   - μ—°κ²° λ„μ κ°μ§€ μ–΄λ ¤μ›€

### π” μμ‹¬ ν”„λ΅μ„Έμ¤: runnv

- λ©”λ¨λ¦¬ 61% (2.4GB) μ‚¬μ©
- Next.jsμ™€ λ¬΄κ΄€ν• ν”„λ΅μ„Έμ¤
- μ •μ²΄ λ¶λ… (λ³΄μ• κ²€ν†  ν•„μ”)

## ν•΄κ²° λ°©μ•

### 1. DATABASE_URLμ— μ—°κ²° ν’€ νλΌλ―Έν„° μ¶”κ°€ (μ°μ„ μμ„: λ†’μ)

**ν„μ¬**:
```
DATABASE_URL="postgresql://user:pass@host:5432/db?sslmode=require"
```

**μμ • ν›„**:
```
DATABASE_URL="postgresql://user:pass@host:5432/db?sslmode=require&connection_limit=10&pool_timeout=20&connect_timeout=10"
```

**νλΌλ―Έν„° μ„¤λ…**:
- `connection_limit=10`: μµλ€ 10κ°μ μ—°κ²°λ§ ν—μ© (Prismaμ©)
- `pool_timeout=20`: μ—°κ²° ν’€μ—μ„ μ—°κ²°μ„ κΈ°λ‹¤λ¦¬λ” μµλ€ μ‹κ°„ (μ΄)
- `connect_timeout=10`: μ—°κ²° μ‹λ„ μµλ€ μ‹κ°„ (μ΄)

### 2. λ°°ν¬ μ›ν¬ν”λ΅μ° μλ™ μ μ©

`.github/workflows/deploy-aws.yml`μ—μ„ μλ™μΌλ΅ μ—°κ²° ν’€ νλΌλ―Έν„°λ¥Ό μ¶”κ°€ν•λ„λ΅ μμ •λ¨.

### 3. Prisma Client μ¬μƒμ„±

λ°°ν¬ μ‹ μλ™μΌλ΅ Prisma Clientκ°€ μ¬μƒμ„±λ©λ‹λ‹¤.

### 4. λ¨λ‹ν„°λ§ μ¶”κ°€

λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° μλ¥Ό λ¨λ‹ν„°λ§ν•λ” μ¤ν¬λ¦½νΈ μ¶”κ°€.

## μμƒ ν¨κ³Ό

1. **μ—°κ²° λ„μ λ°©μ§€**: μµλ€ μ—°κ²° μ μ ν•μΌλ΅ λ¬΄ν• μ¦κ°€ λ°©μ§€
2. **λ©”λ¨λ¦¬ μ‚¬μ©λ‰ κ°μ†**: λ¶ν•„μ”ν• μ—°κ²° μ κ±°
3. **μ„±λ¥ ν–¥μƒ**: μ—°κ²° ν’€ κ΄€λ¦¬ μµμ ν™”
4. **μ•μ •μ„± ν–¥μƒ**: μ—°κ²° νƒ€μ„μ•„μ›ƒμΌλ΅ λ¬΄ν• λ€κΈ° λ°©μ§€

## λ¨λ‹ν„°λ§ μ§€ν‘

### ν™•μΈν•΄μ•Ό ν•  μ§€ν‘

1. **λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° μ**
   ```bash
   psql "$DATABASE_URL" -c "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"
   ```

2. **λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¶”μ΄**
   - Next.js λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ΄ κ³„μ† μ¦κ°€ν•λ”μ§€
   - μ „μ²΄ μ‹μ¤ν… λ©”λ¨λ¦¬ μ‚¬μ©λ¥ 

3. **μ‘λ‹µ μ‹κ°„**
   - ν‰κ·  μ‘λ‹µ μ‹κ°„
   - λλ¦° μΏΌλ¦¬

## μμƒ μ›μΈ (ν™•λ¥  μ)

1. **λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° λ„μ (80%)**
   - Prisma μ—°κ²° ν’€ λ―Έμ„¤μ •
   - μ—°κ²°μ΄ μ λ€λ΅ λ‹«νμ§€ μ•μ
   - μ‹κ°„μ΄ μ§€λ‚ μλ΅ μ—°κ²° μ μ¦κ°€ β†’ λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¦κ°€ β†’ μ‘λ‹µ μ§€μ—°

2. **μ‹μ¤ν… λ©”λ¨λ¦¬ λ¶€μ΅± (15%)**
   - μ „μ²΄ λ©”λ¨λ¦¬ 82% μ‚¬μ©
   - μ¤μ™‘ μ‚¬μ©μΌλ΅ μΈν• μ„±λ¥ μ €ν•
   - `runnv` ν”„λ΅μ„Έμ¤κ°€ λ©”λ¨λ¦¬ κ³Όλ‹¤ μ‚¬μ©

3. **κΈ°νƒ€ (5%)**
   - νΉμ • API μ—”λ“ν¬μΈνΈμ μ„±λ¥ λ¬Έμ 
   - λ„¤νΈμ›ν¬ λ¬Έμ 

## ν•΄κ²° μ™„λ£ μ‚¬ν•­

β… **λ°°ν¬ μ›ν¬ν”λ΅μ° μμ •**: DATABASE_URLμ— μλ™μΌλ΅ μ—°κ²° ν’€ νλΌλ―Έν„° μ¶”κ°€  
β… **Prisma μ„¤μ • κ°μ„ **: μ—°κ²° ν’€ μ„¤μ • μ£Όμ„ μ¶”κ°€  
β… **μ§„λ‹¨ μ¤ν¬λ¦½νΈ μ¶”κ°€**: λ¬Έμ  μ›μΈ νμ•… λ„κµ¬  
β… **μλ™ λ³µκµ¬ μ‹μ¤ν…**: μ‘λ‹µ μ—†μ κ°μ§€ λ° μλ™ μ¬μ‹μ‘  

## λ‹¤μ λ°°ν¬ μ‹

λ‹¤μ λ°°ν¬κ°€ μ™„λ£λλ©΄:
1. DATABASE_URLμ— μ—°κ²° ν’€ νλΌλ―Έν„°κ°€ μλ™μΌλ΅ μ¶”κ°€λ¨
2. Prisma Clientκ°€ μ¬μƒμ„±λ¨
3. μ„λ²„κ°€ μ¬μ‹μ‘λ¨
4. μ—°κ²° λ„μ λ¬Έμ κ°€ ν•΄κ²°λ  κ²ƒμΌλ΅ μμƒλ¨

## μ¶”κ°€ κ¶μ¥μ‚¬ν•­

### 1. μ •κΈ°μ μΈ λ¨λ‹ν„°λ§

```bash
# μ£Ό 1ν μ‹¤ν–‰
./deploy/diagnose-root-cause.sh
```

### 2. λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° λ¨λ‹ν„°λ§

```bash
# μ—°κ²° μ ν™•μΈ
psql "$DATABASE_URL" -c "SELECT count(*) FROM pg_stat_activity;"
```

### 3. λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ¶”μ 

```bash
# PM2 λ©”λ¨λ¦¬ μ‚¬μ©λ‰
pm2 list | grep iamvet
```

## κ²°λ΅ 

**Next.js μ„λ²„ μμ²΄λ” λ¬Έμ κ°€ μ—†μµλ‹λ‹¤.**  
**μ‹¤μ  λ¬Έμ λ” λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²° λ„μ κ°€λ¥μ„±**μ…λ‹λ‹¤.

ν•΄κ²°μ±…μ΄ μ μ©λλ©΄:
- β… μ—°κ²° μκ°€ μ ν•λμ–΄ λ„μ λ°©μ§€
- β… λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μ•μ •ν™”
- β… μ„λ²„ μ‘λ‹µ μ§€μ—° λ¬Έμ  ν•΄κ²°

**μλ™ λ³µκµ¬ μ‹μ¤ν…**κ³Ό ν•¨κ» μ΄μν•λ©΄ μλ™ κ°μ… μ—†μ΄ μ•μ •μ μΌλ΅ μ΄μ κ°€λ¥ν•©λ‹λ‹¤.
