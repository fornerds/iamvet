# 재시작 방지 개선 사항

## 🚨 문제 상황

### 발생한 문제

1. **프로그램 핵심 파일 손상**
   - Node.js/PM2 바이너리 손상
   - 실행 시 즉시 "Killed" 발생
   - 서버는 켜져 있지만 웹서비스 실행 불가

2. **과도한 자동 재시작**
   - 헬스체크가 문제를 감지하고 재시작 시도
   - 재시작 과정에서 프로그램이 더 손상됨
   - 악순환 반복

3. **502 Bad Gateway 오류**
   - 서버는 실행 중이지만 프로그램이 즉시 종료
   - Nginx가 응답을 받지 못함

## ✅ 해결 방법

### 1. Node.js 런타임 완전 복구

**문제**: 손상된 Node.js/PM2 바이너리

**해결**:
- 기존 Node.js 완전 제거
- NodeSource 저장소에서 최신 안정 버전 재설치
- PM2 재설치

**결과**:
- Node.js v20.19.6 설치 완료
- PM2 v6.0.14 설치 완료
- 정상 실행 확인

### 2. 과도한 재시작 방지

**문제**: 헬스체크가 과도하게 재시작 시도

**해결**: 헬스체크 스크립트 개선

#### 개선 사항

1. **최소 재시작 간격 설정**
   ```bash
   MIN_RESTART_INTERVAL=300  # 5분 (300초)
   ```
   - 최근 재시작 후 5분 이내에는 재시작 건너뜀
   - 과도한 재시작 방지

2. **재시작 횟수 추적**
   ```bash
   RESTART_COUNT_FILE="/home/ubuntu/iamvet/logs/restart-count.txt"
   LAST_RESTART_FILE="/home/ubuntu/iamvet/logs/last-restart.txt"
   ```
   - 재시작 횟수 및 시간 기록
   - 문제 패턴 분석 가능

3. **연속 실패 경고**
   ```bash
   if [ $RESTART_COUNT -ge 5 ]; then
       echo "🚨 경고: 재시작 횟수가 ${RESTART_COUNT}회에 도달했습니다."
   fi
   ```
   - 5회 이상 재시작 시 경고 로그
   - 근본 원인 확인 필요 알림

4. **3회 재시도 후 재시작**
   ```bash
   RETRY_COUNT=3
   ```
   - 즉시 재시작하지 않고 3회 재시도
   - 일시적 문제와 실제 문제 구분

### 3. PM2 설정 개선

**배포 워크플로우에 반영된 설정**:

```javascript
{
  autorestart: true,
  max_memory_restart: '1.5G',
  min_uptime: '10s',        // 최소 10초 실행되어야 정상으로 간주
  max_restarts: 10,          // 최대 10회 재시작 후 중단
  max_restarts_delay: 4000   // 재시작 간 최소 4초 대기
}
```

**효과**:
- 너무 빠른 재시작 방지
- 메모리 부족 시 자동 재시작
- 무한 재시작 루프 방지

## 📊 개선 전후 비교

### 개선 전

- ❌ 헬스체크: 문제 감지 시 즉시 재시작
- ❌ 재시작 간격: 제한 없음
- ❌ 재시작 횟수: 추적 안 됨
- ❌ 문제: 과도한 재시작으로 프로그램 손상

### 개선 후

- ✅ 헬스체크: 3회 재시도 후 재시작
- ✅ 재시작 간격: 최소 5분
- ✅ 재시작 횟수: 추적 및 경고
- ✅ 결과: 안전한 자동 복구

## 🔄 작동 방식

### 정상 상황

```
[5분마다 헬스체크]
  ↓
서버 응답 확인 (3회 재시도)
  ↓
✅ 정상 응답
  ↓
로그 기록: "✅ Next.js 서버 정상 응답"
```

### 문제 발생 시

```
[5분마다 헬스체크]
  ↓
서버 응답 확인 (3회 재시도)
  ↓
❌ 응답 없음
  ↓
최근 재시작 시간 확인
  ↓
5분 이상 경과?
  ├─ 예 → PM2 재시작
  └─ 아니오 → 재시작 건너뜀 (로그만 기록)
  ↓
재시작 후 응답 확인
  ↓
✅ 복구 완료 또는 ❌ 실패 (경고)
```

## 📋 설정 파일

### 헬스체크 스크립트

- 위치: `/home/ubuntu/iamvet/health-check.sh`
- 실행 주기: 5분마다 (Cron)
- 로그: `/home/ubuntu/iamvet/logs/health-check.log`

### 재시작 추적 파일

- 재시작 횟수: `/home/ubuntu/iamvet/logs/restart-count.txt`
- 마지막 재시작 시간: `/home/ubuntu/iamvet/logs/last-restart.txt`

## 🎯 예방 조치

### 1. 정기적인 모니터링

```bash
# 헬스체크 로그 확인
tail -f /home/ubuntu/iamvet/logs/health-check.log

# 재시작 횟수 확인
cat /home/ubuntu/iamvet/logs/restart-count.txt

# PM2 상태 확인
pm2 status
```

### 2. 경고 알림 (선택사항)

재시작 횟수가 5회 이상이면 알림 설정 가능:

```bash
# Slack, Discord, 이메일 등으로 알림 전송
```

### 3. 근본 원인 분석

재시작이 자주 발생하면:
- 메모리 누수 확인
- 데이터베이스 연결 문제 확인
- 코드 오류 확인
- 로그 분석

## ✅ 확인 사항

### 현재 적용된 개선 사항

- [x] 최소 재시작 간격 (5분)
- [x] 재시작 횟수 추적
- [x] 연속 실패 경고
- [x] 3회 재시도 후 재시작
- [x] PM2 설정 개선
- [x] 배포 워크플로우에 반영

### 테스트 방법

```bash
# 헬스체크 수동 실행
/home/ubuntu/iamvet/health-check.sh

# 재시작 간격 테스트
# 1. 서버를 일시적으로 중지
# 2. 헬스체크 실행 (재시작 시도)
# 3. 5분 이내 다시 실행 (재시작 건너뜀 확인)
```

## 📚 관련 문서

- [Node.js 런타임 복구 가이드](NODE_RUNTIME_FIX.md)
- [자동 복구 시스템](AUTO_RECOVERY_SYSTEM.md)
- [메모리 업그레이드 가이드](MEMORY_UPGRADE_GUIDE.md)

## 🚀 결론

**사용자가 설명한 문제와 해결 방법이 정확히 반영되었습니다:**

1. ✅ Node.js/PM2 완전 재설치로 런타임 복구
2. ✅ 과도한 재시작 방지 로직 추가
3. ✅ 재시작 횟수 추적 및 경고
4. ✅ 안정적인 자동 복구 시스템 구축

**앞으로 같은 문제가 발생하지 않도록 구성이 개선되었습니다.**

