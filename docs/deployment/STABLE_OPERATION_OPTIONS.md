# 안정적인 운영 방안

현재 메모리 부족 문제로 인한 서버 불안정을 해결하기 위한 두 가지 옵션입니다.

## 🔍 현재 문제 상황

- **메모리 부족 (OOM)**: PM2 프로세스가 "Killed"됨
- **502 Bad Gateway**: Next.js 서버가 응답하지 않음
- **자동 복구 실패**: 재시작 후에도 서버가 응답하지 않음

## 옵션 1: AWS에서 안정적으로 운영 (권장)

### 즉시 해결 방법

#### 1. 메모리 제한 낮추기

PM2 메모리 제한을 낮춰서 OOM 킬러를 방지:

```javascript
// ecosystem.config.js
max_memory_restart: '500M'  // 1G → 500M로 변경
```

#### 2. 서버 사양 업그레이드

**현재**: t3.medium (2코어, 3.7GB 메모리)  
**권장**: t3.large (2코어, 8GB 메모리) 또는 t3.xlarge (4코어, 16GB 메모리)

**비용**: 약 $0.0832/시간 → $0.1664/시간 (약 2배)

#### 3. 메모리 최적화

- 불필요한 프로세스 제거
- Next.js 빌드 최적화
- 데이터베이스 연결 풀 최적화

### 장기 해결 방법

#### 1. 정기적인 재시작 스케줄

매일 새벽 자동 재시작으로 메모리 초기화:

```bash
0 3 * * * pm2 restart iamvet
```

#### 2. 메모리 모니터링 및 알림

메모리 사용량이 80% 이상이면 알림:

```bash
# cron job 추가
*/10 * * * * [ $(free | grep Mem | awk '{print int($3/$2 * 100)}') -gt 80 ] && echo "메모리 부족" | mail -s "Alert" admin@example.com
```

#### 3. 스왑 메모리 증가

현재 2GB → 4GB로 증가:

```bash
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

## 옵션 2: Vercel로 마이그레이션 (가장 안정적)

### Vercel의 장점

1. **자동 스케일링**: 트래픽에 따라 자동 확장
2. **메모리 관리**: 서버리스로 메모리 문제 없음
3. **무료 티어**: 소규모 프로젝트는 무료
4. **자동 배포**: Git 푸시 시 자동 배포
5. **CDN 내장**: 전 세계 빠른 응답 속도
6. **SSL 자동**: Let's Encrypt 자동 설정

### Vercel 마이그레이션 가이드

#### 1. Vercel 프로젝트 생성

```bash
# Vercel CLI 설치
npm i -g vercel

# 로그인
vercel login

# 프로젝트 배포
vercel --prod
```

#### 2. 환경 변수 설정

Vercel 대시보드에서 환경 변수 추가:
- Settings > Environment Variables
- GitHub Secrets와 동일한 환경 변수 추가

#### 3. 도메인 연결

- Settings > Domains
- `iam-vet.com` 추가
- DNS 설정 (Route 53에서 CNAME 레코드 추가)

#### 4. 자동 배포 설정

- GitHub 저장소 연결
- `main` 브랜치 푸시 시 자동 배포

### Vercel vs AWS 비교

| 항목 | AWS EC2 | Vercel |
|------|---------|--------|
| **설정 복잡도** | 높음 | 낮음 |
| **메모리 관리** | 수동 | 자동 |
| **스케일링** | 수동 | 자동 |
| **비용** | 고정 ($50-100/월) | 사용량 기반 (무료~$20/월) |
| **안정성** | 중간 (관리 필요) | 높음 (자동 관리) |
| **커스터마이징** | 높음 | 중간 |

## 🎯 권장 사항

### 단기 (즉시 해결)

1. **메모리 제한 낮추기**: PM2 `max_memory_restart`를 500MB로 설정
2. **긴급 재시작**: 서버 재시작으로 메모리 해제
3. **불필요한 프로세스 제거**: `runnv` 등 의심 프로세스 종료

### 중기 (1주일 내)

1. **서버 사양 업그레이드**: t3.medium → t3.large
2. **정기 재시작 스케줄**: 매일 새벽 자동 재시작
3. **메모리 모니터링**: 알림 설정

### 장기 (1개월 내)

**Vercel 마이그레이션 권장**:
- 더 안정적
- 관리 부담 적음
- 비용 효율적 (소규모 프로젝트)
- 자동 스케일링

## 📋 마이그레이션 체크리스트

### AWS에서 안정적으로 운영

- [ ] PM2 메모리 제한 500MB로 설정
- [ ] 서버 사양 업그레이드 (t3.large)
- [ ] 정기 재시작 스케줄 추가
- [ ] 메모리 모니터링 설정
- [ ] 스왑 메모리 증가

### Vercel로 마이그레이션

- [ ] Vercel 계정 생성
- [ ] 프로젝트 배포
- [ ] 환경 변수 설정
- [ ] 도메인 연결
- [ ] DNS 설정 (Route 53)
- [ ] 자동 배포 설정
- [ ] 테스트 및 검증
- [ ] AWS EC2 중지

## 💰 비용 비교

### AWS EC2 (현재)

- t3.medium: 약 $30/월
- t3.large: 약 $60/월
- 데이터 전송: 추가 비용

### Vercel

- 무료 티어: 100GB 대역폭/월
- Pro ($20/월): 1TB 대역폭/월
- Enterprise: 맞춤 가격

**예상**: 소규모 프로젝트는 Vercel이 더 저렴할 수 있음

## 🚀 다음 단계

1. **즉시**: 긴급 해결 스크립트 실행
2. **단기**: 서버 사양 업그레이드 또는 메모리 최적화
3. **장기**: Vercel 마이그레이션 검토

