name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # 수동 실행 가능

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ubuntu
          # 환경 변수들
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          ADMIN_JWT_SECRET: ${{ secrets.ADMIN_JWT_SECRET }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
          NEXT_PUBLIC_S3_BUCKET_NAME: ${{ secrets.NEXT_PUBLIC_S3_BUCKET_NAME }}
          NEXT_PUBLIC_AWS_REGION: ${{ secrets.NEXT_PUBLIC_AWS_REGION }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}
          CORS_ORIGIN: ${{ secrets.CORS_ORIGIN }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_REDIRECT_URI: ${{ secrets.NAVER_REDIRECT_URI }}
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
          NAVER_MAP_CLIENT_SECRET: ${{ secrets.NAVER_MAP_CLIENT_SECRET }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}
          NODE_ENV: production
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << ENDSSH
            set -e
            
            # 프로젝트 디렉토리로 이동
            cd /home/ubuntu/iamvet
            
            # NVM 환경 로드
            export NVM_DIR="\$HOME/.nvm"
            [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
            
            # 최신 코드 가져오기
            echo "=== Git Pull ==="
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # 환경 변수 파일 생성
            echo "=== Creating .env.production ==="
            cat > .env.production << ENVEOF
            NODE_ENV=production
            DATABASE_URL="$DATABASE_URL"
            JWT_SECRET="$JWT_SECRET"
            JWT_REFRESH_SECRET="$JWT_REFRESH_SECRET"
            ADMIN_JWT_SECRET="$ADMIN_JWT_SECRET"
            NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            NEXTAUTH_URL="$NEXTAUTH_URL"
            AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
            AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
            AWS_REGION="$AWS_REGION"
            AWS_S3_BUCKET_NAME="$AWS_S3_BUCKET_NAME"
            NEXT_PUBLIC_S3_BUCKET_NAME="$NEXT_PUBLIC_S3_BUCKET_NAME"
            NEXT_PUBLIC_AWS_REGION="$NEXT_PUBLIC_AWS_REGION"
            NEXT_PUBLIC_SITE_URL="$NEXT_PUBLIC_SITE_URL"
            NEXT_PUBLIC_API_URL="$NEXT_PUBLIC_API_URL"
            NEXT_PUBLIC_BASE_URL="$NEXT_PUBLIC_BASE_URL"
            CORS_ORIGIN="$CORS_ORIGIN"
            KAKAO_CLIENT_ID="$KAKAO_CLIENT_ID"
            KAKAO_CLIENT_SECRET="$KAKAO_CLIENT_SECRET"
            KAKAO_REDIRECT_URI="$KAKAO_REDIRECT_URI"
            GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID"
            GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET"
            GOOGLE_REDIRECT_URI="$GOOGLE_REDIRECT_URI"
            NAVER_CLIENT_ID="$NAVER_CLIENT_ID"
            NAVER_CLIENT_SECRET="$NAVER_CLIENT_SECRET"
            NAVER_REDIRECT_URI="$NAVER_REDIRECT_URI"
            NEXT_PUBLIC_NAVER_MAP_CLIENT_ID="$NEXT_PUBLIC_NAVER_MAP_CLIENT_ID"
            NAVER_MAP_CLIENT_SECRET="$NAVER_MAP_CLIENT_SECRET"
            SMTP_HOST="$SMTP_HOST"
            SMTP_PORT="$SMTP_PORT"
            SMTP_USER="$SMTP_USER"
            SMTP_PASS="$SMTP_PASS"
            SMTP_FROM="$SMTP_FROM"
            EMAIL_USER="$EMAIL_USER"
            EMAIL_APP_PASSWORD="$EMAIL_APP_PASSWORD"
            ENVEOF
            
            # 의존성 설치
            echo "=== Installing Dependencies ==="
            npm ci --production=false
            
            # Prisma 클라이언트 생성
            echo "=== Generating Prisma Client ==="
            npx prisma generate
            
            # Prisma 마이그레이션 실행
            echo "=== Running Migrations ==="
            npx prisma migrate deploy || echo "Migration failed, continuing..."
            
            # Next.js 빌드
            echo "=== Building Next.js Application ==="
            npm run build
            
            # ecosystem.config.js 파일 생성 (항상 최신으로 업데이트)
            echo "=== Creating ecosystem.config.js ==="
            mkdir -p logs
            cat > ecosystem.config.js << 'ECOSYSTEMEOF'
            const fs = require('fs');
            const path = require('path');
            
            const envPath = path.join(__dirname, '.env.production');
            let envVars = {};
            
            if (fs.existsSync(envPath)) {
              const envFile = fs.readFileSync(envPath, 'utf8');
              envFile.split('\n').forEach(line => {
                const match = line.match(/^([^=]+)=(.*)$/);
                if (match) {
                  const key = match[1].trim();
                  const value = match[2].trim().replace(/^["']|["']$/g, '');
                  envVars[key] = value;
                }
              });
            }
            
            const nodeBinPath = path.join(__dirname, 'node_modules', '.bin');
            const nextPath = path.join(nodeBinPath, 'next');
            
            module.exports = {
              apps: [{
                name: 'iamvet',
                script: nextPath,
                args: 'start',
                cwd: '/home/ubuntu/iamvet',
                instances: 1,
                exec_mode: 'fork',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  HOSTNAME: '0.0.0.0',
                  PATH: process.env.PATH + ':' + nodeBinPath,
                  ...envVars
                },
                error_file: '/home/ubuntu/iamvet/logs/pm2-error.log',
                out_file: '/home/ubuntu/iamvet/logs/pm2-out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
                merge_logs: true,
                autorestart: true,
                max_memory_restart: '1G',
                watch: false,
                ignore_watch: ['node_modules', 'logs', '.next'],
                min_uptime: '10s',
                max_restarts: 10
              }]
            };
            ECOSYSTEMEOF
            
            # PM2 재시작
            echo "=== Restarting PM2 ==="
            if pm2 list | grep -q iamvet; then
              pm2 delete iamvet
            fi
            pm2 start ecosystem.config.js
            
            # PM2 상태 확인
            pm2 status
            pm2 save
            
            echo "=== Deployment Complete ==="
          ENDSSH

      - name: Health Check
        run: |
          sleep 10
          # HTTP와 HTTPS 모두 확인
          curl -f http://${{ secrets.EC2_HOST }} || echo "HTTP check failed, trying HTTPS..."
          curl -f -k https://${{ secrets.EC2_HOST }} || echo "HTTPS check failed"

